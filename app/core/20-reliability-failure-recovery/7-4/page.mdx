# 7.4 — External Side-Effect Recovery: Undoing Agent Actions

The team at a logistics company watched their monitoring dashboard flash red at 3:47 AM. Their AI agent had been autonomously booking shipment slots with carrier partners for the past two hours. The bug in the new model deployment meant the agent had double-booked 1,847 shipments — creating duplicate orders with different carriers for the same cargo. By the time the incident was detected, 412 of those bookings had already triggered automated invoicing from the carriers. The team could roll back the model. They could restore internal state. But they couldn't undo the fact that their agent had taken actions in external systems that now had real-world consequences. They spent the next sixteen hours manually calling carrier partners to cancel bookings, explain the error, and negotiate invoice reversals. The total cost of the incident was not the bad model deployment — it was the irreversible actions that model had taken.

AI agents that interact with the world create a recovery problem that model failures alone never do. When a classification model fails, you fix the model and re-classify. When an agent fails, it may have already sent emails, made API calls, modified databases, charged credit cards, or triggered workflows in partner systems. Recovery is not just about restoring your own system state — it is about undoing or compensating for actions that have already happened outside your control boundary.

## The Side-Effect Problem in Agent Systems

Traditional software recovery focuses on internal state. You restore a database snapshot, replay a transaction log, revert a configuration change. The failure and the recovery both happen within systems you control. Agent systems break this model. An agent takes an action in an external system. That action creates state in a system owned by someone else. Your rollback procedures have no direct access to that state.

The side-effect problem has three layers. First, you need to know what actions the agent took. If your audit trail is incomplete, you cannot even enumerate the things you need to undo. Second, you need to determine which actions are reversible. Some actions can be undone through an API call or a database update. Others are permanent. Third, you need to execute reversal procedures before external state propagates further. An email sent to a customer creates state in their inbox — reversible if you act fast enough. That email read by the customer creates state in their memory — irreversible.

A financial services company learned this in late 2025 when their agent system incorrectly initiated 284 wire transfers due to a prompt injection vulnerability. The team detected the problem within six minutes. But wire transfers settle through external banking networks with different processing windows. Forty-three transfers had already cleared and reached recipient accounts. Those were irreversible. The remaining 241 were still pending and could be canceled through the bank's API. The difference between reversible and irreversible was timing — and the team did not have automated procedures to execute reversals at the speed required.

## Identifying Reversible vs Irreversible Actions

Not all agent actions have the same recovery properties. You need a classification system that determines what can be undone, what requires compensation, and what is permanent. This classification drives your recovery procedures.

**Fully reversible actions** can be undone through an automated procedure with no external human involvement. These include: creating a draft document, adding an item to a shopping cart, scheduling a meeting invitation that has not been sent, updating a mutable field in a database you control, creating a log entry, adding a row to a queue. Recovery procedure: execute the inverse operation through the same API the agent used to create the action.

**Time-limited reversible actions** can be undone, but only within a specific window before external state propagates. These include: sending an email before the recipient opens it, canceling an API call before the remote system processes it, deleting a social media post before users see it, canceling a payment before it clears, retracting a webhook before the receiver acts on it. Recovery procedure: execute reversal immediately upon incident detection, track whether the reversal succeeded before the time window closed, escalate to compensation if the window expired.

**Manually reversible actions** require human involvement from another party to undo. These include: canceling a booking with a partner that requires phone confirmation, requesting invoice reversal from a vendor, asking a user to disregard an email, negotiating refund terms with a payment processor. Recovery procedure: generate reversal work tickets, provide external parties with incident context, track reversal status, escalate when external parties do not respond.

**Irreversible actions** cannot be undone. These include: revealing private information to an unauthorized party, sending a notification to a user who has already read it, triggering a real-world workflow that has already completed, deleting data with no backup, executing a financial transaction that has settled. Recovery procedure: compensation, user notification, incident report, root cause analysis to prevent recurrence.

A healthcare AI platform catalogs every agent action by reversibility tier in their action registry. When the agent calls an API, the registry records the action type, the timestamp, the external system involved, and the reversibility classification. During incident recovery, the system queries the registry for all actions taken during the incident window, sorts by reversibility tier, and generates a prioritized reversal task list. Fully reversible actions execute automatically. Time-limited actions execute immediately with human confirmation. Manually reversible actions generate support tickets. Irreversible actions trigger compensation workflows. The entire recovery process is driven by action metadata captured at execution time.

## Audit Trails for Agent Actions

You cannot undo what you do not know happened. Agent systems require audit trails that capture every external action with sufficient detail to support reversal. The audit trail is not optional observability — it is recovery infrastructure.

The minimum viable audit entry contains: timestamp with millisecond precision, agent session ID, agent version or model ID, action type, target system or API endpoint, action parameters, action result or response code, external transaction ID if available, user ID or account ID affected, reversibility classification, estimated reversal cost. This is not logging for debugging — this is a recovery ledger.

Most teams discover their audit trail is insufficient during the first major incident. They can see that the agent made API calls, but not which specific records were modified. They can see that emails were sent, but not to which recipients. They can see that payments were initiated, but not the external transaction IDs needed to cancel them. The recovery procedure stalls because the team cannot enumerate the actions that need reversal.

A SaaS company implemented audit trail requirements after a September 2025 incident where their agent incorrectly deleted 1,203 customer records. The team knew records were deleted — their deletion logs showed the events. But the logs did not capture which specific records, only the count. The team had to reconstruct the list of affected records by analyzing application logs, database snapshots, and customer support tickets. Reconstruction took eleven hours. Restoration from backup took forty minutes. Eighty percent of the recovery time was spent figuring out what to restore.

The audit trail must be durable and independent from the agent system itself. If the agent system fails, the audit trail must survive. Store audit data in a separate database or object store with higher durability guarantees than your primary system. Write audit entries synchronously before confirming action completion to the agent. If writing the audit entry fails, fail the action — never take an action you cannot audit.

The audit trail must also be queryable at the speed of incident response. During recovery, you need to query all actions taken in the past hour, or all actions affecting a specific user, or all actions of a specific type, in under five seconds. Index the audit trail by timestamp, user ID, action type, and external system. Recovery procedures that wait thirty seconds for audit queries are recovery procedures that do not execute fast enough.

## Reversal Procedures for Common Actions

Certain agent actions appear across nearly every agent system. You can build standardized reversal procedures for these common patterns. The reversal procedure library reduces recovery time from "figure out what to do during the incident" to "execute the procedure we already designed."

**Email reversal** has two modes. If the email has not been delivered, cancel it through your email service provider's API. Most ESPs support message cancellation if the message is still in the sending queue. If the email has been delivered, send a follow-up email with a clear subject line — "Disregard previous message" — that explains the error and asks the recipient to ignore the earlier email. Include the original email's subject line and timestamp in the follow-up so recipients can identify which message to disregard. For sensitive errors, consider whether recalling the message through Exchange or Outlook's recall feature is appropriate, but understand that recall is unreliable and often fails if the recipient has already opened the message.

**API action reversal** depends on whether the external API supports idempotent deletes or updates. If the agent created a resource, attempt to delete it using the resource ID from the audit trail. If the agent updated a resource, attempt to restore it to its previous state using the before-image captured in the audit trail. If the external API does not support reversal operations, escalate to manual reversal through the partner's support channel.

**Database write reversal** is straightforward if you control the database. Query the audit trail for all records modified during the incident window. For each record, either restore the previous value from the before-image in the audit trail, or delete the record if it was created during the incident. Execute reversals in a transaction to ensure atomicity. If the database is owned by another system, use that system's API to request reversal, or escalate to manual coordination.

**Payment reversal** depends on payment state. If the payment has been authorized but not captured, void the authorization. If the payment has been captured but not settled, refund it through your payment processor's API. If the payment has settled, initiate a refund and expect a multi-day settlement window. If the payment processor does not support automated refunds, generate a manual refund task for your finance team. Track refund status through completion to ensure the user actually receives the refund.

**Notification reversal** is mostly irreversible. If you sent a push notification, you cannot unsend it. The best recovery is to send a follow-up notification explaining the error. If you triggered an in-app notification that has not been seen, delete it from the notification queue before the user opens the app. If you sent an SMS, send a follow-up SMS with a clear correction. For critical errors, consider whether a phone call is warranted.

A legal tech company maintains a reversal procedure library with automated and manual procedures for every action type their agent can execute. The library includes the API calls required for reversal, the expected success rates, the escalation path if automated reversal fails, and the estimated time and cost for each procedure. When an incident occurs, the recovery orchestrator queries the audit trail for all actions taken, looks up the reversal procedure for each action type, and executes the procedures in priority order. The orchestrator tracks success and failure rates and escalates to manual review for any reversal that fails. The entire recovery process is codified and testable.

## When Reversal Is Impossible

Some actions cannot be undone. The agent revealed private data to an unauthorized party. The agent sent a legally binding contract that the recipient has already signed. The agent triggered a physical shipment that has already left the warehouse. The agent deleted a backup that was the only copy of critical data. Reversal is not an option. You must accept that the action is permanent and focus on minimizing downstream damage.

The first step in irreversible action recovery is **containment**. If the agent is still running, stop it immediately. If the action created ongoing consequences — like a recurring job that will continue to execute — cancel the recurring workflow. If the action exposed data, revoke access tokens or credentials that the agent used. Containment prevents the irreversible action from compounding.

The second step is **damage assessment**. How bad is it? How many users are affected? What data was exposed or what commitments were made? What are the legal, financial, or reputational consequences? Damage assessment determines the severity of the incident and the level of escalation required. A minor irreversible action might require user notification and an apology. A major irreversible action might require legal review, regulatory disclosure, and executive involvement.

The third step is **user notification**. If users are affected, they need to know. The notification should be clear, specific, and honest. What happened, what data or actions were involved, what you are doing about it, and what users should do next. Do not minimize or obscure the error. Users trust transparency. They do not trust corporate doublespeak.

A recruiting platform's agent accidentally sent offer letters to 67 candidates who had not been selected. The offer letters included salary details and start dates. The agent error was detected eighteen minutes after the first letters were sent. By that time, 41 candidates had opened the emails. Reversal was impossible — the candidates had already seen the offers. The company's recovery procedure: immediate notification to all 67 candidates explaining the error and apologizing, individual phone calls to each candidate from a recruiter to explain the situation, a formal written apology from the VP of HR, and a 500 dollar Amazon gift card sent to each affected candidate as compensation for the confusion and disappointment. The company also implemented a mandatory human approval gate for all offer letters. The incident cost approximately 33,000 dollars in gift cards and 92 hours of recruiter time. The reputational cost was harder to measure, but several candidates posted about the incident on social media, and the company's Glassdoor reviews reflected the incident for months.

## Compensation Instead of Reversal

When reversal is impossible, compensation makes the user whole. Compensation is not the same as refund. Refund returns money the user paid. Compensation provides value to offset harm caused by the agent's error, even when the user did not pay anything.

Compensation has three goals. First, restore the user to the state they would have been in if the error had not occurred. If the agent deleted a user's document, compensation includes restoring the document from backup and providing premium support to verify the restoration. Second, offset the user's time and frustration dealing with the error. If the user spent two hours on the phone with support resolving the issue, compensation acknowledges that time. Third, maintain the user's trust and willingness to continue using your product. Compensation is relationship repair.

Compensation types include: monetary compensation — refunds, credits, gift cards, direct payments; service compensation — free months of service, upgraded account tier, dedicated support; time compensation — priority processing, expedited delivery, extended deadlines; access compensation — unlocking features, removing usage caps, providing data exports. The appropriate compensation type depends on the severity of the harm and the user's expectations.

A customer support AI agent incorrectly canceled a user's insurance policy due to a classification error. The user discovered the cancellation when they attempted to file a claim and were told they had no active policy. The insurance company's recovery procedure: immediately reinstate the policy with retroactive coverage to the cancellation date, process the user's claim as if the policy had never been canceled, waive the next three months of premiums as compensation, assign a dedicated account manager to the user for the next twelve months to rebuild trust. The total cost of compensation was approximately 2,100 dollars in waived premiums plus the cost of the claim that would have been denied without reinstatement. The alternative — losing the customer and facing a potential lawsuit — was far more expensive.

Compensation must be proportional to harm. Over-compensate and you set expectations that are unsustainable. Under-compensate and users feel dismissed. The compensation decision requires judgment. For minor errors with no material harm, an apology and a small credit may be sufficient. For major errors with real consequences, significant compensation is required. The decision should involve product, legal, and finance — not just the on-call engineer during the incident.

## Prevention: Action Confirmation Gates

The best recovery procedure is the one you never need to execute. Action confirmation gates prevent agent errors from creating irreversible consequences in the first place. A confirmation gate is a pause point before an action with high stakes or low reversibility where a human reviews and approves the action before the agent executes it.

Confirmation gates apply to actions that meet specific criteria: irreversible or time-limited reversible actions, actions involving money above a specific threshold, actions that modify or delete user data, actions that send messages to users or external parties, actions that trigger workflows in partner systems, actions that require legal or compliance review. Not every agent action needs confirmation. Confirmation gates are friction. They slow down the agent and reduce automation value. Apply gates strategically to high-risk actions only.

A confirmation gate implementation includes: a queue of pending actions waiting for human review, a review interface that shows the action type, target, parameters, and risk assessment, a one-click approve or reject flow for reviewers, an SLA for review time so actions do not wait indefinitely, an escalation path if no reviewer is available, and automated approval for low-risk actions that match approved patterns. The gate is not a full stop — it is a filter that catches high-risk actions while allowing safe actions to proceed.

A financial AI agent uses confirmation gates for any transaction above 10,000 dollars, any wire transfer to a new recipient, and any account closure. The agent queues the action and sends a notification to the account manager. The account manager reviews the action in a dashboard that shows the agent's reasoning, the transaction details, and recent account history. The manager approves or rejects the action with a single click. Approved actions execute immediately. Rejected actions are logged, and the agent is notified not to retry. The median review time is 47 seconds. The gate prevents high-stakes errors without adding significant delay to normal operations.

Confirmation gates are not foolproof. A human reviewer can approve a bad action if the agent's reasoning appears sound. But gates shift the error mode from "the agent did something irreversible" to "the agent proposed something bad and a human approved it." That shift matters. Human-approved errors are easier to understand, explain, and defend than fully autonomous errors. The gate also creates a natural audit trail — every high-risk action has a human reviewer attached to it in the logs.

The next subchapter covers compensating transactions for AI actions — the formal pattern for designing compensation workflows when reversal is not possible.

